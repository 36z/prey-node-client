#!/bin/bash
####################################################################
# Prey Debian Postinst Script
# Written by Tom√°s Pollak <tomas@forkhq.com> - (c) 2011 Fork Ltd.
# License: GPLv3
####################################################################

set -e

VERSION='1.0.0'
PREY_USER="prey"
BASE_PATH="/usr/lib/prey"
CONFIG_DIR="/etc/prey"
LOG_FILE="/var/log/prey.log"
INSTALL_PATH="${BASE_PATH}/versions/${VERSION}"
PREY_BIN="bin/prey"

if [ -d /usr/share/prey ]; then
  rm -Rf /usr/share/prey
  (sudo crontab -l | grep -v prey) sudo crontab -
fi

case "$1" in
  configure)
    bash "$INSTALL_PATH/scripts/create_user.sh" $PREY_USER || true
    mkdir -p $CONFIG_DIR
    touch $LOG_FILE

    # set up permissions
    chown -R $PREY_USER: $CONFIG_DIR $BASE_PATH $LOG_FILE
    # as prey_user: symlink, write crontab, generate prey.conf
    cd "$INSTALL_PATH"
    su $PREY_USER -c "$PREY_BIN config activate"
    "$PREY_BIN" config hooks post_install
    "$PREY_BIN" config gui
  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
  ;;

  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 1
  ;;

esac

exit 0
